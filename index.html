<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é  - InBodyFit</title>
	    <style>
	    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
	
	    :root {
	        --primary-color: #d48885;
	        --glass-bg: rgba(255, 255, 255, 0.1);
	        --glass-border: 1px solid rgba(255, 255, 255, 0.15);
	        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
	    }
	
	    body {
	        margin: 0;
	        font-family: 'Noto Sans TC', sans-serif;
	        background-image: url("images/bg.jpg");
	        background-size: cover;
	        background-position: center;
	        background-attachment: fixed; /* èƒŒæ™¯å›ºå®šï¼Œè£½é€ è¦–å·®æ„Ÿ */
	        min-height: 100vh;
	        color: #fff;
	        display: flex;
	        flex-direction: column;
	    }
	
	    body::before {
	        content: "";
	        position: absolute;
	        inset: 0;
	        background: rgba(18, 18, 18, 0.7); /* æ·±è‰²é®ç½©ï¼Œè®“å…§å®¹æ›´æ¸…æ¥š */
	        backdrop-filter: blur(5px);
	        z-index: -1;
	        position: fixed; /* å›ºå®šé®ç½© */
	    }
	
	    /* é ‚éƒ¨å°èˆªæ¬„ */
	    .header {
	        position: sticky;
	        top: 0;
	        z-index: 100;
	        background: rgba(0, 0, 0, 0.3);
	        backdrop-filter: blur(10px);
	        padding: 15px 5%;
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        border-bottom: var(--glass-border);
	    }
	
	    .header .logo {
	        font-size: 26px;
	        font-weight: 700;
	        color: #fff;
	        text-decoration: none;
	        letter-spacing: 1px;
	        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
	    }
	    
	    .header .logo span { color: var(--primary-color); } /* å¯å°‡ InBodyFit çš„ Fit è®Šè‰² */
	
	    .nav-menu { display: flex; gap: 40px; }
	
	    .nav-menu a {
	        color: rgba(255, 255, 255, 0.85);
	        text-decoration: none;
	        font-size: 16px;
	        font-weight: 500;
	        padding: 8px 0;
	        position: relative;
	        transition: color 0.3s;
	    }
	
	    .nav-menu a:hover { color: #fff; }
	
	    /* å°èˆªåº•ç·šå‹•ç•« */
	    .nav-menu a::after {
	        content: '';
	        position: absolute;
	        width: 0;
	        height: 2px;
	        bottom: 0;
	        left: 0;
	        background-color: var(--primary-color);
	        transition: width 0.3s;
	    }
	    .nav-menu a:hover::after { width: 100%; }
	
	    .user-info { display: flex; align-items: center; gap: 20px; }
	    .user-info .username-display { font-weight: 500; font-size: 15px; }
	    
	    .logout-btn {
	        background: transparent;
	        border: 1px solid rgba(255,255,255,0.4);
	        color: #fff;
	        padding: 6px 16px;
	        border-radius: 20px;
	        cursor: pointer;
	        transition: all 0.3s;
	    }
	    .logout-btn:hover {
	        background: rgba(255,255,255,0.15);
	        border-color: #fff;
	    }
	
	    /* ä¸»è¦å…§å®¹å€ */
	    .content {
	        flex-grow: 1;
	        display: flex;
	        justify-content: center;
	        padding: 40px 20px;
	        width: 100%;
	        max-width: 1200px;
	        margin: 0 auto;
	        box-sizing: border-box;
	    }
	
	    /* æ­¡è¿é¢æ¿ */
	    .welcome-message {
	        background: var(--glass-bg);
	        backdrop-filter: blur(12px);
	        padding: 60px;
	        border-radius: 24px;
	        border: var(--glass-border);
	        box-shadow: var(--glass-shadow);
	        text-align: center;
	        max-width: 800px;
	        animation: fadeIn 0.8s ease-out;
	    }
	
	    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
	
	    .welcome-message h1 { font-size: 42px; margin-bottom: 20px; color: #fff; }
	    .welcome-message p { font-size: 18px; line-height: 1.8; color: rgba(255,255,255,0.8); }
	
	    /* åŠŸèƒ½å€å¡Šé€šç”¨æ¨£å¼ */
	    section {
	        background: var(--glass-bg);
	        backdrop-filter: blur(12px);
	        border-radius: 24px;
	        border: var(--glass-border);
	        padding: 30px;
	        box-shadow: var(--glass-shadow);
	        animation: fadeIn 0.5s ease-out;
	    }
	
	    section h2 {
	        border-bottom: 1px solid rgba(255,255,255,0.1);
	        padding-bottom: 15px;
	        margin-top: 0;
	        font-size: 24px;
	        color: var(--primary-color);
	    }
	
	    /* æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†é€šç”¨ */
	    button {
	        background: var(--primary-color);
	        color: #fff;
	        border: none;
	        padding: 10px 20px;
	        border-radius: 8px;
	        cursor: pointer;
	        font-weight: 600;
	        transition: filter 0.2s;
	    }
	    button:hover { filter: brightness(1.1); }
	    button:disabled { opacity: 0.6; cursor: not-allowed; }
	
	    input, textarea {
	        background: rgba(0,0,0,0.3);
	        border: 1px solid rgba(255,255,255,0.1);
	        color: #fff;
	        border-radius: 8px;
	        padding: 10px;
	        font-family: inherit;
	    }
	    input:focus, textarea:focus { outline: none; border-color: var(--primary-color); background: rgba(0,0,0,0.5); }
	
	    /* è¨“ç·´åˆ—è¡¨å„ªåŒ– */
	    #trainingList li {
	        background: rgba(255, 255, 255, 0.05) !important; /* è¦†è“‹åŸæœ‰ inline style */
	        border-left: 4px solid var(--primary-color);
	        margin-bottom: 10px !important;
	        border-radius: 8px !important;
	        padding: 15px !important;
	        transition: transform 0.2s;
	    }
	    #trainingList li:hover { transform: translateX(5px); background: rgba(255,255,255,0.08) !important; }
	
	    /* èœå–®å¡ç‰‡ç¶²æ ¼ */
	    #menuList {
	        display: grid;
	        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
	        gap: 20px !important;
	    }
	    #menuList > div {
	        background: rgba(255, 255, 255, 0.05) !important;
	        border: 1px solid rgba(255,255,255,0.1);
	        transition: transform 0.3s;
	        display: flex;
	        flex-direction: column;
	        justify-content: space-between;
	    }
	    #menuList > div:hover { transform: translateY(-5px); border-color: var(--primary-color); }
	
	    /* AI èŠå¤©å®¤å„ªåŒ– */
	    #chatLog {
	        background: rgba(0,0,0,0.2) !important;
	        border: 1px solid rgba(255,255,255,0.05);
	        display: flex;
	        flex-direction: column;
	        gap: 12px;
	    }
	    
	    #chatLog div {
	        padding: 10px 14px;
	        border-radius: 12px;
	        max-width: 80%;
	        line-height: 1.5;
	        font-size: 15px;
	    }
	
	    /* é€™è£¡éœ€è¦é…åˆ JS ä¿®æ”¹ï¼Œç¨å¾®ç”¨ CSS é¸æ“‡å™¨ç¡¬æ”¹çµæ§‹é¡¯ç¤º */
	    /* å‡è¨­ JS è¼¸å‡ºçš„çµæ§‹æ˜¯ <div><strong>æˆ‘:</strong> text</div> */
	    /* æˆ‘å€‘å¯ä»¥ç”¨ JS ä¿®æ”¹ï¼Œæˆ–è€…ç°¡å–®ç”¨ CSS ç¾åŒ– */
	    
	    /* éŸ¿æ‡‰å¼ */
	    @media (max-width: 768px) {
	        .header { flex-direction: column; gap: 15px; padding: 15px; }
	        .nav-menu { width: 100%; justify-content: center; gap: 20px; font-size: 14px; }
	        .content { padding: 20px 10px; }
	        .welcome-message { padding: 30px; }
	        .welcome-message h1 { font-size: 28px; }
	    }
	</style>
</head>

<body>
    <header class="header">
        <a href="index.html" class="logo">InBodyFit</a>
        <nav class="nav-menu">
            <a href="#" onclick="showFeature('myTraining')">æˆ‘çš„è¨“ç·´ğŸ‹ï¸</a>
            <a href="#" onclick="showFeature('myBMI')">è‡ªå·±çš„BMI</a>
            <a href="#" onclick="showFeature('mealPlan')">èœå–®</a>
            <a href="#" onclick="showFeature('aiAdvisor')">AIé¡§å•</a>
        </nav>
        <div class="user-info">
            <span class="username-display" id="loggedInUserName">è¼‰å…¥ä¸­...</span>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>
    </header>

    <main class="content">
        <div class="welcome-message" id="welcomeBox">
            <h1 id="welcomeGreeting">æ­¡è¿å›ä¾†ï¼</h1>
            <p>é–‹å§‹æ‚¨çš„æ™ºæ…§å¥èº«ä¹‹æ—…å§ï¼åœ¨é€™è£¡ï¼Œæ‚¨å¯ä»¥ç®¡ç†æ‚¨çš„è¨“ç·´ã€è¿½è¹¤BMIã€é¸æ“‡èœå–®ä¸¦ç²å¾—AIçš„å°ˆæ¥­å»ºè­°ã€‚</p>
            <p>é»æ“Šä¸Šæ–¹å°èˆªæ¬„çš„åŠŸèƒ½é¸é …ä¾†æ¢ç´¢æ›´å¤šå…§å®¹ã€‚</p>
        </div>

        <!-- æ–°å¢: å„åŠŸèƒ½å€å¡Š -->
        <div id="featureContent" style="display: none; width:100%; max-width:1000px;">
            <!-- æˆ‘çš„è¨“ç·´ -->
            <section id="myTraining" style="display:none; margin:20px auto; color:#fff;">
                <h2>æˆ‘çš„è¨“ç·´</h2>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:300px;">
                        <h3>è¨“ç·´æ¸…å–®</h3>
                        <ul id="trainingList" style="list-style:none; padding:0;"></ul>
                    </div>
                    <div style="flex:1; min-width:300px;">
                        <h3>æ‰‹å‹•æ–°å¢è¨“ç·´</h3>
                        <form id="addTrainingForm">
                            <input id="t_name" placeholder="é‹å‹•åç¨±" required style="width:100%; padding:8px; margin-bottom:6px;">
                            <input id="t_sets" placeholder="æ¯çµ„æ•¸ (ä¾‹å¦‚:3)" type="number" min="1" style="width:48%; padding:8px; margin-right:4%;">
                            <input id="t_reps" placeholder="æ¯æ¬¡æ¬¡æ•¸ (ä¾‹å¦‚:12)" type="number" min="1" style="width:48%; padding:8px;">
                            <button type="submit" style="margin-top:8px; padding:8px 12px;">æ–°å¢åˆ°æˆ‘çš„è¨“ç·´</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- è‡ªå·±çš„BMI -->
            <section id="myBMI" style="display:none; margin:20px auto; color:#fff;">
                <h2>è‡ªå·±çš„ BMI</h2>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:280px;">
                        <label>èº«é«˜ (cm)</label>
                        <input id="heightInput" type="number" min="50" value="" style="width:100%; padding:8px; margin-bottom:8px;">
                        <label>é«”é‡ (kg)</label>
                        <input id="weightInput" type="number" min="20" value="" style="width:100%; padding:8px; margin-bottom:8px;">
                        <button id="saveMeasureBtn" style="padding:8px 12px;">å„²å­˜</button>
                    </div>
                    <div style="flex:1; min-width:280px;">
                        <h3>ç•¶å‰ BMI</h3>
                        <p id="currentBMI">å°šæœªè¼¸å…¥èº«é«˜/é«”é‡</p>
                        <h3>æœˆåº•é æœŸ BMI</h3>
                        <p id="expectedBMI">è«‹å…ˆå„²å­˜æ¸¬é‡å€¼ä¸¦ç¢ºèªè¨“ç·´æ¸…å–®</p>
                        <p style="font-size:0.9em; opacity:0.9;">é æœŸé‚è¼¯ï¼šæ ¹æ“šç›®å‰ã€Œæˆ‘çš„è¨“ç·´ã€é …ç›®æ•¸åšä¿å®ˆä¼°è¨ˆ (æ¯é …è¦–ç‚ºæ¯å‘¨ä¸€æ¬¡ï¼Œæœˆå…§ä¾å‰©é¤˜é€±æ•¸èª¿æ•´)</p>
                    </div>
                </div>
            </section>

            <!-- èœå–® -->
            <section id="mealPlan" style="display:none; margin:20px auto; color:#fff;">
                <h2>å»ºè­°é‹å‹•èœå–®</h2>
                <p>æŒ‘é¸å–œæ­¡çš„é‹å‹•ï¼Œä¸¦è¨­å®šçµ„æ•¸èˆ‡æ¬¡æ•¸ï¼ŒåŠ å…¥ã€Œæˆ‘çš„è¨“ç·´ã€ã€‚</p>
                <div id="menuList" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;"></div>
            </section>

            <!-- AIé¡§å• -->
            <section id="aiAdvisor" style="display:none; margin:20px auto; color:#fff;">
                <h2>AI é¡§å• (èªéŸ³èŠå¤©å®¤)</h2>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:300px;">
                        <div id="chatLog" style="height:260px; overflow:auto; background:rgba(255,255,255,0.06); padding:12px; border-radius:8px;"></div>
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button id="startRec">ğŸ¤ èªéŸ³è¼¸å…¥</button>
                            <button id="stopRec" disabled>åœæ­¢</button>
                            <button id="speakLast">ğŸ”Š å”¸å‡º AI å›è¦†</button>
                        </div>
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <textarea id="userMsg" placeholder="è¼¸å…¥è¨Šæ¯..." style="width:100%; height:120px; padding:8px;"></textarea>
                        <button id="sendMsg" style="margin-top:8px; padding:8px 12px;">é€å‡º</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js';

        // Firebase è¨­å®š - è«‹ç¢ºä¿èˆ‡ login.html å’Œ register.html ä¸€è‡´
        const firebaseConfig = {
            apiKey: "AIzaSyBYvosLMm7SaPAFQzwuwuUDfFqsSXk5kTY",
            authDomain: "smart-gym-men.firebaseapp.com",
            projectId: "smart-gym-men",
            storageBucket: "smart-gym-men.firebasestorage.app",
            messagingSenderId: "175956584528",
            appId: "1:175956584528:web:8213558230e49784568955",
            measurementId: "G-NMSFH2SKV7"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI references
        const welcomeBox = document.getElementById('welcomeBox');
        const featureContent = document.getElementById('featureContent');
        const sections = {
            myTraining: document.getElementById('myTraining'),
            myBMI: document.getElementById('myBMI'),
            mealPlan: document.getElementById('mealPlan'),
            aiAdvisor: document.getElementById('aiAdvisor')
        };

        // Simple hardcoded menu suggestions
        const suggestedMenu = [
            { name: 'æ·±è¹² (Squat)', defaultSets: 3, defaultReps: 10 },
            { name: 'ä¼åœ°æŒºèº« (Push-up)', defaultSets: 3, defaultReps: 12 },
            { name: 'ç¡¬èˆ‰ (Deadlift)', defaultSets: 3, defaultReps: 6 },
            { name: 'å¹³æ¿æ”¯æ’ (Plank)', defaultSets: 3, defaultReps: 60 }, // seconds
            { name: 'åå§¿åˆ’èˆ¹ (Seated Row)', defaultSets: 3, defaultReps: 10 },
        ];

        // Navigation visibility
        window.showFeature = (featureName) => {
            welcomeBox.style.display = 'none';
            featureContent.style.display = 'block';
            Object.keys(sections).forEach(k => sections[k].style.display = 'none');
            if (sections[featureName]) sections[featureName].style.display = 'block';
            // load data when opened
            if (featureName === 'myTraining') loadTraining();
            if (featureName === 'mealPlan') renderMenu();
            if (featureName === 'myBMI') computeAndShowBMI();
        };

        // Auth state and load user-specific data
        let currentUser = null;
        onAuthStateChanged(auth, async (user) => {
            const userNameDisplay = document.getElementById('loggedInUserName');
            const welcomeGreeting = document.getElementById('welcomeGreeting');

            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    const displayName = userData.name || userData.username || user.email;
                    userNameDisplay.textContent = `æ­¡è¿, ${displayName}`;
                    welcomeGreeting.textContent = `æ­¡è¿å›ä¾†, ${userData.name || userData.username || user.email}ï¼`;
                } else {
                    userNameDisplay.textContent = `æ­¡è¿, ${user.email}`;
                    welcomeGreeting.textContent = `æ­¡è¿å›ä¾†, ${user.email}ï¼`;
                }
                // preload menu and training
                renderMenu();
                loadTraining();
                loadMeasurementsToInputs();
            } else {
                alert("æ‚¨å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥ï¼");
                window.location.href = "login.html";
            }
        });

        // Training CRUD
        const trainingListEl = document.getElementById('trainingList');

        function renderTrainingItem(docSnap) {
            const data = docSnap.data();
            const id = docSnap.id;
            const li = document.createElement('li');
            li.style = "background:rgba(255,255,255,0.04); padding:10px; margin-bottom:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;";
            const left = document.createElement('div');
            left.innerHTML = `<strong>${data.name}</strong><br><small>çµ„: ${data.sets} Ã— æ¬¡: ${data.reps}</small>`;
            const right = document.createElement('div');
            right.style.display = 'flex';
            right.style.gap = '8px';
            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.checked = !!data.completed;
            chk.addEventListener('change', () => toggleComplete(id, chk.checked));
            const del = document.createElement('button');
            del.textContent = 'åˆªé™¤';
            del.addEventListener('click', () => removeTraining(id));
            right.appendChild(chk);
            right.appendChild(del);
            li.appendChild(left);
            li.appendChild(right);
            li.id = `t-${id}`;
            return li;
        }

        let trainingUnsub = null;
        function loadTraining() {
            if (!currentUser) return;
            // æ¸…ç©ºç¾æœ‰åˆ—è¡¨
            trainingListEl.innerHTML = '';
            // ä½¿ç”¨ onSnapshot ç›£è½ users/{uid}/trainings
            if (trainingUnsub) trainingUnsub(); // å–æ¶ˆå…ˆå‰ç›£è½
            const col = collection(db, 'users', currentUser.uid, 'trainings');
            trainingUnsub = onSnapshot(col, (snap) => {
                trainingListEl.innerHTML = '';
                snap.forEach(docSnap => {
                    const li = renderTrainingItem(docSnap);
                    trainingListEl.appendChild(li);
                });
                // æ›´æ–° BMI ç•«é¢é æœŸï¼ˆè‹¥ç•¶å‰é¡¯ç¤ºï¼‰
                if (sections.myBMI.style.display !== 'none') computeAndShowBMI();
            });
        }

        async function addTraining(data) {
            if (!currentUser) return alert('æœªç™»å…¥');
            const col = collection(db, 'users', currentUser.uid, 'trainings');
            await addDoc(col, { ...data, completed: false, createdAt: Date.now() });
        }

        async function toggleComplete(id, checked) {
            if (!currentUser) return;
            const tDoc = doc(db, 'users', currentUser.uid, 'trainings', id);
            await updateDoc(tDoc, { completed: checked });
        }

        async function removeTraining(id) {
            if (!currentUser) return;
            const tDoc = doc(db, 'users', currentUser.uid, 'trainings', id);
            await deleteDoc(tDoc);
        }

        // Add training form submit
        document.getElementById('addTrainingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('t_name').value.trim();
            const sets = Number(document.getElementById('t_sets').value) || 3;
            const reps = Number(document.getElementById('t_reps').value) || 10;
            if (!name) return alert('è«‹è¼¸å…¥é‹å‹•åç¨±');
            await addTraining({ name, sets, reps });
            e.target.reset();
        });

        // Render menu suggestions
        const menuListEl = document.getElementById('menuList');
        function renderMenu() {
            menuListEl.innerHTML = '';
            suggestedMenu.forEach((m, idx) => {
                const card = document.createElement('div');
                card.style = "background:rgba(255,255,255,0.04); padding:12px; border-radius:8px;";
                card.innerHTML = `<strong>${m.name}</strong><div style="margin-top:8px;">
					<label>çµ„æ•¸ <input type="number" value="${m.defaultSets}" min="1" id="menu_sets_${idx}" style="width:60px"></label>
					<label style="margin-left:8px;">æ¬¡æ•¸ <input type="number" value="${m.defaultReps}" min="1" id="menu_reps_${idx}" style="width:60px"></label>
					</div>`;
                const btn = document.createElement('button');
                btn.textContent = 'åŠ å…¥è¨“ç·´';
                btn.style.marginTop = '8px';
                btn.addEventListener('click', async () => {
                    const sets = Number(document.getElementById(`menu_sets_${idx}`).value) || m.defaultSets;
                    const reps = Number(document.getElementById(`menu_reps_${idx}`).value) || m.defaultReps;
                    await addTraining({ name: m.name, sets, reps });
                    alert(`${m.name} å·²åŠ å…¥æˆ‘çš„è¨“ç·´`);
                });
                card.appendChild(btn);
                menuListEl.appendChild(card);
            });
        }

        // BMI logic: save/load measurements and compute expected BMI
        const heightInput = document.getElementById('heightInput');
        const weightInput = document.getElementById('weightInput');
        const currentBMIEl = document.getElementById('currentBMI');
        const expectedBMIEl = document.getElementById('expectedBMI');
        document.getElementById('saveMeasureBtn').addEventListener('click', saveMeasurements);

        async function saveMeasurements() {
            if (!currentUser) return alert('æœªç™»å…¥');
            const h = Number(heightInput.value);
            const w = Number(weightInput.value);
            if (!h || !w) return alert('è«‹è¼¸å…¥æ­£ç¢ºèº«é«˜é«”é‡');
            const uDoc = doc(db, 'users', currentUser.uid);
            await setDoc(uDoc, { measurements: { height: h, weight: w, timestamp: Date.now() } }, { merge: true });
            alert('å·²å„²å­˜');
            computeAndShowBMI();
        }

        async function loadMeasurementsToInputs() {
            if (!currentUser) return;
            const uDocRef = doc(db, 'users', currentUser.uid);
            const snap = await getDoc(uDocRef);
            if (snap.exists()) {
                const d = snap.data();
                if (d.measurements) {
                    heightInput.value = d.measurements.height || '';
                    weightInput.value = d.measurements.weight || '';
                }
            }
        }

        function computeBMI(hCm, wKg) {
            if (!hCm || !wKg) return null;
            const hM = hCm / 100;
            return +(wKg / (hM * hM)).toFixed(2);
        }

        function weeksUntilMonthEnd() {
            const today = new Date();
            const end = new Date(today.getFullYear(), today.getMonth() + 1, 0); // last day of month
            const diffDays = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
            return Math.max(1, Math.round(diffDays / 7)); // at least 1 week
        }

        async function computeAndShowBMI() {
            const h = Number(heightInput.value);
            const w = Number(weightInput.value);
            const cur = computeBMI(h, w);
            currentBMIEl.textContent = cur ? `${cur}` : 'å°šæœªè¼¸å…¥èº«é«˜/é«”é‡';
            // estimate reduction: assume each training item equals 1 session/week; each session => conservative -0.08 kg bodyweight per session/week for month
            // use item count from training collection
            if (!currentUser) {
                expectedBMIEl.textContent = 'æœªç™»å…¥';
                return;
            }
            // fetch trainings once
            const trainingsCol = collection(db, 'users', currentUser.uid, 'trainings');
            const snap = await getDoc(doc(db, 'users', currentUser.uid)); // quick read to ensure exists (we could do query but keep simple)
            // count items by reading snapshot via onSnapshot would be async; instead do a single get using onSnapshot not available here -> use onSnapshot data cached via loadTraining listener.
            // We'll estimate based on DOM list count:
            const itemCount = trainingListEl.children.length || 0;
            if (!cur) {
                expectedBMIEl.textContent = 'è«‹å…ˆè¼¸å…¥èº«é«˜/é«”é‡';
                return;
            }
            const weeks = weeksUntilMonthEnd();
            // conservative weight change per training item per week (kg)
            const kgPerItemPerWeek = -0.08; // conservative
            const expectedWeightChange = itemCount * kgPerItemPerWeek * weeks;
            const currentWeight = w;
            const expectedWeight = +(currentWeight + expectedWeightChange).toFixed(1);
            const expectedBMI = computeBMI(h, expectedWeight);
            expectedBMIEl.textContent = expectedBMI ? `${expectedBMI}ï¼ˆä¼°è¨ˆé«”é‡ ${expectedWeight} kgï¼‰` : 'ç„¡æ³•è¨ˆç®—';
        }

        // AI é¡§å• (æœ¬åœ° Web Speech API + ç°¡å–®å›è¦†)
        const chatLog = document.getElementById('chatLog');
        const userMsg = document.getElementById('userMsg');
        const sendMsgBtn = document.getElementById('sendMsg');
        const startRecBtn = document.getElementById('startRec');
        const stopRecBtn = document.getElementById('stopRec');
        const speakLastBtn = document.getElementById('speakLast');

        let lastAIResp = '';
        sendMsgBtn.addEventListener('click', () => {
            const text = userMsg.value.trim();
            if (!text) return;
            appendChat('æˆ‘', text);
            userMsg.value = '';
            aiRespond(text);
        });

		function appendChat(who, text) {
		    const div = document.createElement('div');
		    // åˆ¤æ–·æ˜¯èª°ç™¼è¨€ï¼Œçµ¦äºˆä¸åŒçš„ class
		    const isUser = who === 'æˆ‘' || who.includes('æˆ‘');
		    
		    div.style.cssText = `
		        padding: 10px 15px;
		        border-radius: 18px;
		        margin-bottom: 10px;
		        max-width: 75%;
		        word-wrap: break-word;
		        font-size: 15px;
		        line-height: 1.5;
		        align-self: ${isUser ? 'flex-end' : 'flex-start'};
		        background-color: ${isUser ? '#d48885' : 'rgba(255,255,255,0.15)'};
		        color: #fff;
		        border-bottom-${isUser ? 'right' : 'left'}-radius: 4px;
		    `;
		    
		    // ä¸å†é¡¯ç¤º "æˆ‘:" æˆ– "AI:" é€™äº›å­—çœ¼ï¼Œç›´æ¥é¡¯ç¤ºå…§å®¹ï¼Œé å·¦å³ä½ç½®å€åˆ†
		    div.textContent = text; 
		    
		    chatLog.appendChild(div);
		    chatLog.scrollTop = chatLog.scrollHeight;
		}

        function aiRespond(text) {
            // very small rule-based replies for offline demo
            const low = text.toLowerCase();
            let resp = "æŠ±æ­‰ï¼Œæˆ‘ç›®å‰åªèƒ½æä¾›ç°¡å–®å»ºè­°ã€‚è«‹æ›´å…·é«”æè¿°å•é¡Œã€‚";
            if (low.includes('æ¸›è‚¥') || low.includes('ç˜¦')) resp = "å»ºè­°æ¯é€±ç¶­æŒæœ‰æ°§èˆ‡é˜»åŠ›è¨“ç·´ï¼Œä¸¦èª¿æ•´é£²é£Ÿï¼›æ¯é€±è‡³å°‘3æ¬¡ä¸­åº¦é‹å‹•ã€‚";
            if (low.includes('å¢è‚Œ')) resp = "å»ºè­°å¢åŠ è›‹ç™½è³ªæ”å–èˆ‡æ¯é€±3-4æ¬¡çš„é˜»åŠ›è¨“ç·´ï¼Œé€æ­¥é€²è¡Œé‡é‡éå¢ã€‚";
            if (low.includes('å»ºè­°') || low.includes('èœå–®')) resp = "æ¨è–¦ï¼šæ·±è¹²ã€ç¡¬èˆ‰ã€è‡¥æ¨ã€åˆ’èˆ¹ï¼Œå¯äº¤æ›¿å®‰æ’ä¸Š/ä¸‹/ä¼‘æ¯æ—¥ã€‚";
            if (low.includes('å—¨') || low.includes('hello') || low.includes('hi')) resp = "å—¨ï¼éœ€è¦ä»€éº¼è¨“ç·´å»ºè­°å—ï¼Ÿ";
            lastAIResp = resp;
            appendChat('AI', resp);
            speakText(resp);
        }

        // TTS
        function speakText(text) {
            if (!('speechSynthesis' in window)) return;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-TW';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        }
        speakLastBtn.addEventListener('click', () => {
            if (lastAIResp) speakText(lastAIResp);
        });

        // STT (Chrome)
        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.lang = 'zh-TW';
            recognition.interimResults = false;
            recognition.continuous = false;
            recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                appendChat('æˆ‘(èªéŸ³)', txt);
                aiRespond(txt);
            };
            recognition.onerror = (e) => console.error('STT error', e);
            recognition.onend = () => {
                startRecBtn.disabled = false;
                stopRecBtn.disabled = true;
            };
        } else {
            startRecBtn.disabled = true;
            startRecBtn.title = 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜';
        }

        startRecBtn.addEventListener('click', () => {
            if (!recognition) return;
            recognition.start();
            startRecBtn.disabled = true;
            stopRecBtn.disabled = false;
        });
        stopRecBtn.addEventListener('click', () => {
            if (!recognition) return;
            recognition.stop();
            startRecBtn.disabled = false;
            stopRecBtn.disabled = true;
        });

        // ç™»å‡ºåŠŸèƒ½ (ä¿ç•™åŸæœ‰)
        window.logout = async () => {
            try {
                await signOut(auth);
                alert("æ‚¨å·²æˆåŠŸç™»å‡ºï¼");
                window.location.href = "login.html";
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—ï¼š", error);
                alert("ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        };

    </script>
</body>

</html>
