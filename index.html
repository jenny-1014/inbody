<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é  - InBodyFit</title>
	    <style>
	    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
	
	    :root {
	        --primary-color: #d48885;
	        --glass-bg: rgba(255, 255, 255, 0.1);
	        --glass-border: 1px solid rgba(255, 255, 255, 0.15);
	        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
	    }
	
	    body {
	        margin: 0;
	        font-family: 'Noto Sans TC', sans-serif;
	        background-image: url("images/bg.jpg");
	        background-size: cover;
	        background-position: center;
	        background-attachment: fixed; /* èƒŒæ™¯å›ºå®šï¼Œè£½é€ è¦–å·®æ„Ÿ */
	        min-height: 100vh;
	        color: #fff;
	        display: flex;
	        flex-direction: column;
	    }
	
	    body::before {
	        content: "";
	        position: absolute;
	        inset: 0;
	        background: rgba(18, 18, 18, 0.7); /* æ·±è‰²é®ç½©ï¼Œè®“å…§å®¹æ›´æ¸…æ¥š */
	        backdrop-filter: blur(5px);
	        z-index: -1;
	        position: fixed; /* å›ºå®šé®ç½© */
	    }
	
	    /* é ‚éƒ¨å°èˆªæ¬„ */
	    .header {
	        position: sticky;
	        top: 0;
	        z-index: 100;
	        background: rgba(0, 0, 0, 0.3);
	        backdrop-filter: blur(10px);
	        padding: 15px 5%;
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        border-bottom: var(--glass-border);
	    }
	
	    .header .logo {
	        font-size: 26px;
	        font-weight: 700;
	        color: #fff;
	        text-decoration: none;
	        letter-spacing: 1px;
	        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
	    }
	    
	    .header .logo span { color: var(--primary-color); } /* å¯å°‡ InBodyFit çš„ Fit è®Šè‰² */
	
	    .nav-menu { display: flex; gap: 40px; }
	
	    .nav-menu a {
	        color: rgba(255, 255, 255, 0.85);
	        text-decoration: none;
	        font-size: 16px;
	        font-weight: 500;
	        padding: 8px 0;
	        position: relative;
	        transition: color 0.3s;
	    }
	
	    .nav-menu a:hover { color: #fff; }
	
	    /* å°èˆªåº•ç·šå‹•ç•« */
	    .nav-menu a::after {
	        content: '';
	        position: absolute;
	        width: 0;
	        height: 2px;
	        bottom: 0;
	        left: 0;
	        background-color: var(--primary-color);
	        transition: width 0.3s;
	    }
	    .nav-menu a:hover::after { width: 100%; }
	
	    .user-info { display: flex; align-items: center; gap: 20px; }
	    .user-info .username-display { font-weight: 500; font-size: 15px; }
	    
	    .logout-btn {
	        background: transparent;
	        border: 1px solid rgba(255,255,255,0.4);
	        color: #fff;
	        padding: 6px 16px;
	        border-radius: 20px;
	        cursor: pointer;
	        transition: all 0.3s;
	    }
	    .logout-btn:hover {
	        background: rgba(255,255,255,0.15);
	        border-color: #fff;
	    }
	
	    /* ä¸»è¦å…§å®¹å€ */
	    .content {
	        flex-grow: 1;
	        display: flex;
	        justify-content: center;
	        padding: 40px 20px;
	        width: 100%;
	        max-width: 1200px;
	        margin: 0 auto;
	        box-sizing: border-box;
	    }
	
	    /* æ­¡è¿é¢æ¿ */
	    .welcome-message {
	        background: var(--glass-bg);
	        backdrop-filter: blur(12px);
	        padding: 60px;
	        border-radius: 24px;
	        border: var(--glass-border);
	        box-shadow: var(--glass-shadow);
	        text-align: center;
	        max-width: 800px;
	        animation: fadeIn 0.8s ease-out;
	    }
	
	    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
	
	    .welcome-message h1 { font-size: 42px; margin-bottom: 20px; color: #fff; }
	    .welcome-message p { font-size: 18px; line-height: 1.8; color: rgba(255,255,255,0.8); }
	
	    /* åŠŸèƒ½å€å¡Šé€šç”¨æ¨£å¼ */
	    section {
	        background: var(--glass-bg);
	        backdrop-filter: blur(12px);
	        border-radius: 24px;
	        border: var(--glass-border);
	        padding: 30px;
	        box-shadow: var(--glass-shadow);
	        animation: fadeIn 0.5s ease-out;
	    }
	
	    section h2 {
	        border-bottom: 1px solid rgba(255,255,255,0.1);
	        padding-bottom: 15px;
	        margin-top: 0;
	        font-size: 24px;
	        color: var(--primary-color);
	    }
	
	    /* æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†é€šç”¨ */
	    button {
	        background: var(--primary-color);
	        color: #fff;
	        border: none;
	        padding: 10px 20px;
	        border-radius: 8px;
	        cursor: pointer;
	        font-weight: 600;
	        transition: filter 0.2s;
	    }
	    button:hover { filter: brightness(1.1); }
	    button:disabled { opacity: 0.6; cursor: not-allowed; }
	
	    input, textarea {
	        background: rgba(0,0,0,0.3);
	        border: 1px solid rgba(255,255,255,0.1);
	        color: #fff;
	        border-radius: 8px;
	        padding: 10px;
	        font-family: inherit;
	    }
	    input:focus, textarea:focus { outline: none; border-color: var(--primary-color); background: rgba(0,0,0,0.5); }
	
	    /* è¨“ç·´åˆ—è¡¨å„ªåŒ– */
	    #trainingList li {
	        background: rgba(255, 255, 255, 0.05) !important; /* è¦†è“‹åŸæœ‰ inline style */
	        border-left: 4px solid var(--primary-color);
	        margin-bottom: 10px !important;
	        border-radius: 8px !important;
	        padding: 15px !important;
	        transition: transform 0.2s;
	    }
	    #trainingList li:hover { transform: translateX(5px); background: rgba(255,255,255,0.08) !important; }
	
	    /* èœå–®å¡ç‰‡ç¶²æ ¼ */
	    #menuList {
	        display: grid;
	        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
	        gap: 20px !important;
	    }
	    #menuList > div {
	        background: rgba(255, 255, 255, 0.05) !important;
	        border: 1px solid rgba(255,255,255,0.1);
	        transition: transform 0.3s;
	        display: flex;
	        flex-direction: column;
	        justify-content: space-between;
	    }
	    #menuList > div:hover { transform: translateY(-5px); border-color: var(--primary-color); }
	
	    /* AI èŠå¤©å®¤å„ªåŒ– */
	    #chatLog {
	        background: rgba(0,0,0,0.2) !important;
	        border: 1px solid rgba(255,255,255,0.05);
	        display: flex;
	        flex-direction: column;
	        gap: 12px;
	    }
	    
	    #chatLog div {
	        padding: 10px 14px;
	        border-radius: 12px;
	        max-width: 80%;
	        line-height: 1.5;
	        font-size: 15px;
	    }
	
	    /* é€™è£¡éœ€è¦é…åˆ JS ä¿®æ”¹ï¼Œç¨å¾®ç”¨ CSS é¸æ“‡å™¨ç¡¬æ”¹çµæ§‹é¡¯ç¤º */
	    /* å‡è¨­ JS è¼¸å‡ºçš„çµæ§‹æ˜¯ <div><strong>æˆ‘:</strong> text</div> */
	    /* æˆ‘å€‘å¯ä»¥ç”¨ JS ä¿®æ”¹ï¼Œæˆ–è€…ç°¡å–®ç”¨ CSS ç¾åŒ– */
	    
	    /* éŸ¿æ‡‰å¼ */
	    @media (max-width: 768px) {
	        .header { flex-direction: column; gap: 15px; padding: 15px; }
	        .nav-menu { width: 100%; justify-content: center; gap: 20px; font-size: 14px; }
	        .content { padding: 20px 10px; }
	        .welcome-message { padding: 30px; }
	        .welcome-message h1 { font-size: 28px; }
	    }
	</style>
</head>

<body>
    <header class="header">
        <a href="index.html" class="logo">InBodyFit</a>
        <nav class="nav-menu">
			<a href="#" onclick="showFeature('myTraining')">æˆ‘çš„è¨“ç·´ğŸ‹ï¸</a>
			<a href="#" onclick="showFeature('myInBody')">æˆ‘çš„InBody</a> 
			<a href="#" onclick="showFeature('mealPlan')">èœå–®</a>
			<a href="#" onclick="showFeature('aiAdvisor')">AIé¡§å•</a>
        </nav>
        <div class="user-info">
            <span class="username-display" id="loggedInUserName">è¼‰å…¥ä¸­...</span>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>
    </header>

    <main class="content">
        <div class="welcome-message" id="welcomeBox">
            <h1 id="welcomeGreeting">æ­¡è¿å›ä¾†ï¼</h1>
            <p>é–‹å§‹æ‚¨çš„æ™ºæ…§å¥èº«ä¹‹æ—…å§ï¼åœ¨é€™è£¡ï¼Œæ‚¨å¯ä»¥ç®¡ç†æ‚¨çš„è¨“ç·´ã€è¿½è¹¤BMIã€é¸æ“‡èœå–®ä¸¦ç²å¾—AIçš„å°ˆæ¥­å»ºè­°ã€‚</p>
            <p>é»æ“Šä¸Šæ–¹å°èˆªæ¬„çš„åŠŸèƒ½é¸é …ä¾†æ¢ç´¢æ›´å¤šå…§å®¹ã€‚</p>
        </div>

        <!-- æ–°å¢: å„åŠŸèƒ½å€å¡Š -->
        <div id="featureContent" style="display: none; width:100%; max-width:1000px;">
            <!-- æˆ‘çš„è¨“ç·´ -->
            <section id="myTraining" style="display:none; margin:20px auto; color:#fff;">
                <h2>æˆ‘çš„è¨“ç·´</h2>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:300px;">
                        <h3>è¨“ç·´æ¸…å–®</h3>
                        <ul id="trainingList" style="list-style:none; padding:0;"></ul>
                    </div>
                    <div style="flex:1; min-width:300px;">
                        <h3>æ‰‹å‹•æ–°å¢è¨“ç·´</h3>
                        <form id="addTrainingForm">
                            <input id="t_name" placeholder="é‹å‹•åç¨±" required style="width:100%; padding:8px; margin-bottom:6px;">
                            <input id="t_sets" placeholder="æ¯çµ„æ•¸ (ä¾‹å¦‚:3)" type="number" min="1" style="width:48%; padding:8px; margin-right:4%;">
                            <input id="t_reps" placeholder="æ¯æ¬¡æ¬¡æ•¸ (ä¾‹å¦‚:12)" type="number" min="1" style="width:48%; padding:8px;">
                            <button type="submit" style="margin-top:8px; padding:8px 12px;">æ–°å¢åˆ°æˆ‘çš„è¨“ç·´</button>
                        </form>
                    </div>
                </div>
            </section>

           <section id="myInBody" style="display:none; margin:20px auto; color:#fff;">
		    <h2>æˆ‘çš„ InBody æ•¸æ“š</h2>
		    <div style="display:flex; gap:20px; flex-wrap:wrap;">
		        <div style="flex:1; min-width:280px;">
		            <h3>è¼¸å…¥æœ€æ–°æ•¸æ“š</h3>
		            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
		                <div>
		                    <label>èº«é«˜ (cm)</label>
		                    <input id="inbody_height" type="number" placeholder="175" style="width:100%; padding:8px; margin-bottom:8px;">
		                </div>
		                <div>
		                    <label>é«”é‡ (kg)</label>
		                    <input id="inbody_weight" type="number" placeholder="70" style="width:100%; padding:8px; margin-bottom:8px;">
		                </div>
		                <div>
		                    <label>éª¨éª¼è‚Œé‡ (kg)</label>
		                    <input id="inbody_muscle" type="number" placeholder="30" style="width:100%; padding:8px; margin-bottom:8px;">
		                </div>
		                <div>
		                    <label>é«”è„‚ç‡ (%)</label>
		                    <input id="inbody_fat" type="number" placeholder="15" style="width:100%; padding:8px; margin-bottom:8px;">
		                </div>
		                <div style="grid-column: span 2;">
		                    <label>åŸºç¤ä»£è¬ (kcal) <small>(é¸å¡«)</small></label>
		                    <input id="inbody_bmr" type="number" placeholder="1600" style="width:100%; padding:8px; margin-bottom:8px;">
		                </div>
		            </div>
		            <button id="saveInBodyBtn" style="padding:10px 20px; margin-top:10px; width:100%;">å„²å­˜ç´€éŒ„</button>
		        </div>
		
		        <div style="flex:1; min-width:280px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px;">
		            <h3>ç•¶å‰èº«é«”çµ„æˆ</h3>
		            <div id="inbodyDisplay">
		                <p>è¼‰å…¥ä¸­...</p>
		            </div>
		            
		            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
		            
		            <h3>ç°¡æ˜“åˆ†æ</h3>
		            <p id="inbodyAnalysis" style="font-size: 0.9em; line-height: 1.6; color: #ddd;">
		                è«‹è¼¸å…¥ä¸¦å„²å­˜æ•¸æ“šä»¥ç²å¾—åˆ†æã€‚
		            </p>
		        </div>
		    </div>
		</section>

            <!-- èœå–® -->
            <section id="mealPlan" style="display:none; margin:20px auto; color:#fff;">
                <h2>å»ºè­°é‹å‹•èœå–®</h2>
                <p>æŒ‘é¸å–œæ­¡çš„é‹å‹•ï¼Œä¸¦è¨­å®šçµ„æ•¸èˆ‡æ¬¡æ•¸ï¼ŒåŠ å…¥ã€Œæˆ‘çš„è¨“ç·´ã€ã€‚</p>
                <div id="menuList" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;"></div>
            </section>

            <!-- AIé¡§å• -->
            <section id="aiAdvisor" style="display:none; margin:20px auto; color:#fff;">
                <h2>AI é¡§å• (èªéŸ³èŠå¤©å®¤)</h2>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:300px;">
                        <div id="chatLog" style="height:260px; overflow:auto; background:rgba(255,255,255,0.06); padding:12px; border-radius:8px;"></div>
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button id="startRec">ğŸ¤ èªéŸ³è¼¸å…¥</button>
                            <button id="stopRec" disabled>åœæ­¢</button>
                            <button id="speakLast">ğŸ”Š å”¸å‡º AI å›è¦†</button>
                        </div>
                    </div>
                    <div style="flex:1; min-width:200px;">
                        <textarea id="userMsg" placeholder="è¼¸å…¥è¨Šæ¯..." style="width:100%; height:120px; padding:8px;"></textarea>
                        <button id="sendMsg" style="margin-top:8px; padding:8px 12px;">é€å‡º</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

<script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js';

        // Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBYvosLMm7SaPAFQzwuwuUDfFqsSXk5kTY",
            authDomain: "smart-gym-men.firebaseapp.com",
            projectId: "smart-gym-men",
            storageBucket: "smart-gym-men.firebasestorage.app",
            messagingSenderId: "175956584528",
            appId: "1:175956584528:web:8213558230e49784568955",
            measurementId: "G-NMSFH2SKV7"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI references
        const welcomeBox = document.getElementById('welcomeBox');
        const featureContent = document.getElementById('featureContent');
        
        // ä¿®æ”¹ï¼šå°æ‡‰ HTML æ­£ç¢ºçš„å€å¡Š ID
        const sections = {
            myTraining: document.getElementById('myTraining'),
            myInBody: document.getElementById('myInBody'), // ä¿®æ­£é€™è£¡å°æ‡‰æ–°çš„ ID
            mealPlan: document.getElementById('mealPlan'),
            aiAdvisor: document.getElementById('aiAdvisor')
        };

        // Simple hardcoded menu suggestions
        const suggestedMenu = [
            { name: 'æ·±è¹² (Squat)', defaultSets: 3, defaultReps: 10 },
            { name: 'ä¼åœ°æŒºèº« (Push-up)', defaultSets: 3, defaultReps: 12 },
            { name: 'ç¡¬èˆ‰ (Deadlift)', defaultSets: 3, defaultReps: 6 },
            { name: 'å¹³æ¿æ”¯æ’ (Plank)', defaultSets: 3, defaultReps: 60 }, // seconds
            { name: 'åå§¿åˆ’èˆ¹ (Seated Row)', defaultSets: 3, defaultReps: 10 },
        ];

        // Navigation visibility
        window.showFeature = (featureName) => {
            welcomeBox.style.display = 'none';
            featureContent.style.display = 'block';
            
            // éš±è—æ‰€æœ‰å€å¡Š
            Object.keys(sections).forEach(k => {
                if(sections[k]) sections[k].style.display = 'none';
            });
            
            // é¡¯ç¤ºé¸å®šå€å¡Š
            if (sections[featureName]) {
                sections[featureName].style.display = 'block';
            }

            // Load data when opened
            if (featureName === 'myTraining') loadTraining();
            if (featureName === 'mealPlan') renderMenu();
            if (featureName === 'myInBody') loadInBodyData(); // ä¿®æ”¹ï¼šè¼‰å…¥ InBody è³‡æ–™
        };

        // Auth state and load user-specific data
        let currentUser = null;
        onAuthStateChanged(auth, async (user) => {
            const userNameDisplay = document.getElementById('loggedInUserName');
            const welcomeGreeting = document.getElementById('welcomeGreeting');

            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                let displayName = user.email;
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    displayName = userData.name || userData.username || user.email;
                }
                
                userNameDisplay.textContent = `æ­¡è¿, ${displayName}`;
                welcomeGreeting.textContent = `æ­¡è¿å›ä¾†, ${displayName}ï¼`;

                // preload menu and training
                renderMenu();
                loadTraining();
                loadInBodyData(); // é å…ˆè¼‰å…¥èº«é«”æ•¸æ“š
            } else {
                alert("æ‚¨å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥ï¼");
                window.location.href = "login.html";
            }
        });

        // ================= Training CRUD =================
        const trainingListEl = document.getElementById('trainingList');

        function renderTrainingItem(docSnap) {
            const data = docSnap.data();
            const id = docSnap.id;
            const li = document.createElement('li');
            // æ³¨æ„ï¼šé€™è£¡çš„æ¨£å¼å·²è¢« HTML head ä¸­çš„ CSS class è¦†è“‹ï¼Œä½†ä¿æŒ inline style ä½œç‚ºå‚™æ¡ˆ
            li.innerHTML = `
                <div style="flex-grow:1;">
                    <strong>${data.name}</strong><br>
                    <small style="color:#ccc;">çµ„æ•¸: ${data.sets} Ã— æ¬¡æ•¸: ${data.reps}</small>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="checkbox" ${data.completed ? 'checked' : ''} class="status-chk">
                    <button class="del-btn" style="background:#ff5555; padding:5px 10px; font-size:12px;">åˆªé™¤</button>
                </div>
            `;
            
            // Event Listeners
            const chk = li.querySelector('.status-chk');
            chk.addEventListener('change', () => toggleComplete(id, chk.checked));
            
            const del = li.querySelector('.del-btn');
            del.addEventListener('click', () => removeTraining(id));

            return li;
        }

        let trainingUnsub = null;
        function loadTraining() {
            if (!currentUser) return;
            if (trainingUnsub) trainingUnsub(); 
            
            const col = collection(db, 'users', currentUser.uid, 'trainings');
            // å³æ™‚ç›£è½
            trainingUnsub = onSnapshot(col, (snap) => {
                trainingListEl.innerHTML = '';
                snap.forEach(docSnap => {
                    const li = renderTrainingItem(docSnap);
                    trainingListEl.appendChild(li);
                });
            });
        }

        async function addTraining(data) {
            if (!currentUser) return alert('æœªç™»å…¥');
            const col = collection(db, 'users', currentUser.uid, 'trainings');
            await addDoc(col, { ...data, completed: false, createdAt: Date.now() });
        }

        async function toggleComplete(id, checked) {
            if (!currentUser) return;
            const tDoc = doc(db, 'users', currentUser.uid, 'trainings', id);
            await updateDoc(tDoc, { completed: checked });
        }

        async function removeTraining(id) {
            if (!currentUser) return;
            if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨“ç·´å—ï¼Ÿ')) return;
            const tDoc = doc(db, 'users', currentUser.uid, 'trainings', id);
            await deleteDoc(tDoc);
        }

        document.getElementById('addTrainingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('t_name').value.trim();
            const sets = Number(document.getElementById('t_sets').value) || 3;
            const reps = Number(document.getElementById('t_reps').value) || 10;
            if (!name) return alert('è«‹è¼¸å…¥é‹å‹•åç¨±');
            await addTraining({ name, sets, reps });
            e.target.reset();
        });

        // ================= Meal Plan / Menu =================
        const menuListEl = document.getElementById('menuList');
        function renderMenu() {
            menuListEl.innerHTML = '';
            suggestedMenu.forEach((m, idx) => {
                const card = document.createElement('div');
                card.innerHTML = `
                    <div style="padding:15px;">
                        <h4 style="margin:0 0 10px 0; color:var(--primary-color);">${m.name}</h4>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <label style="font-size:14px;">çµ„ <input type="number" value="${m.defaultSets}" min="1" id="menu_sets_${idx}" style="width:40px; padding:5px;"></label>
                            <label style="font-size:14px;">æ¬¡ <input type="number" value="${m.defaultReps}" min="1" id="menu_reps_${idx}" style="width:40px; padding:5px;"></label>
                        </div>
                        <button id="btn_add_${idx}" style="width:100%; font-size:13px;">åŠ å…¥è¨“ç·´</button>
                    </div>`;
                
                menuListEl.appendChild(card);
                
                // Add event listener manually
                document.getElementById(`btn_add_${idx}`).addEventListener('click', async () => {
                    const sets = Number(document.getElementById(`menu_sets_${idx}`).value) || m.defaultSets;
                    const reps = Number(document.getElementById(`menu_reps_${idx}`).value) || m.defaultReps;
                    await addTraining({ name: m.name, sets, reps });
                    alert(`${m.name} å·²åŠ å…¥æˆ‘çš„è¨“ç·´`);
                });
            });
        }

        // ================= InBody Logic (New!) =================
        // æŠ“å–æ–°çš„ HTML å…ƒç´  ID
        const inbodyInputs = {
            height: document.getElementById('inbody_height'),
            weight: document.getElementById('inbody_weight'),
            muscle: document.getElementById('inbody_muscle'),
            fat: document.getElementById('inbody_fat'),
            bmr: document.getElementById('inbody_bmr')
        };
        const inbodyDisplay = document.getElementById('inbodyDisplay');
        const inbodyAnalysis = document.getElementById('inbodyAnalysis');
        const saveInBodyBtn = document.getElementById('saveInBodyBtn');

        // å„²å­˜æŒ‰éˆ•ç›£è½
        saveInBodyBtn.addEventListener('click', saveInBodyData);

        async function saveInBodyData() {
            if (!currentUser) return alert('è«‹å…ˆç™»å…¥');

            // å–å¾—è¼¸å…¥å€¼
            const newData = {
                height: Number(inbodyInputs.height.value),
                weight: Number(inbodyInputs.weight.value),
                muscle: Number(inbodyInputs.muscle.value),
                fat: Number(inbodyInputs.fat.value),
                bmr: Number(inbodyInputs.bmr.value),
                updatedAt: Date.now()
            };

            // ç°¡å–®é©—è­‰
            if (!newData.height || !newData.weight) {
                return alert('èº«é«˜èˆ‡é«”é‡ç‚ºå¿…å¡«æ¬„ä½ï¼');
            }

            try {
                const uDoc = doc(db, 'users', currentUser.uid);
                // ä½¿ç”¨ merge: true æ›´æ–° users é›†åˆä¸­çš„ inbody æ¬„ä½
                await setDoc(uDoc, { inbody: newData }, { merge: true });
                alert('InBody æ•¸æ“šå·²æ›´æ–°ï¼');
                renderInBodyStats(newData); // æ›´æ–°ç•«é¢é¡¯ç¤º
            } catch (e) {
                console.error("Save failed", e);
                alert("å„²å­˜å¤±æ•—");
            }
        }

        async function loadInBodyData() {
            if (!currentUser) return;
            const uDocRef = doc(db, 'users', currentUser.uid);
            const snap = await getDoc(uDocRef);
            
            if (snap.exists()) {
                const d = snap.data();
                if (d.inbody) {
                    // å¡«å…¥ Input æ¬„ä½
                    inbodyInputs.height.value = d.inbody.height || '';
                    inbodyInputs.weight.value = d.inbody.weight || '';
                    inbodyInputs.muscle.value = d.inbody.muscle || '';
                    inbodyInputs.fat.value = d.inbody.fat || '';
                    inbodyInputs.bmr.value = d.inbody.bmr || '';

                    // æ›´æ–°å³å´é¡¯ç¤ºèˆ‡åˆ†æ
                    renderInBodyStats(d.inbody);
                } else {
                    inbodyDisplay.innerHTML = '<p style="color:#aaa;">å°šç„¡æ•¸æ“šï¼Œè«‹åœ¨å·¦å´è¼¸å…¥ã€‚</p>';
                }
            }
        }

        function renderInBodyStats(data) {
            // è¨ˆç®— BMI
            const hM = data.height / 100;
            const bmi = (data.weight / (hM * hM)).toFixed(1);

            inbodyDisplay.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><small>BMI</small><br><strong style="font-size:1.4em; color:#d48885;">${bmi}</strong></div>
                    <div><small>éª¨éª¼è‚Œ</small><br><strong>${data.muscle} kg</strong></div>
                    <div><small>é«”è„‚ç‡</small><br><strong>${data.fat} %</strong></div>
                    <div><small>åŸºç¤ä»£è¬</small><br><strong>${data.bmr || '--'} kcal</strong></div>
                </div>
            `;

            // ç”¢ç”Ÿç°¡æ˜“åˆ†æ
            let advice = "";
            if (bmi < 18.5) advice += "æ‚¨çš„é«”é‡éè¼•ï¼Œå»ºè­°å¢åŠ ç‡Ÿé¤Šæ”å–ä¸¦é€²è¡Œå¢è‚Œè¨“ç·´ã€‚";
            else if (bmi >= 24) advice += "æ‚¨çš„ BMI åé«˜ï¼Œå»ºè­°æ­é…æœ‰æ°§é‹å‹•æ§åˆ¶é«”è„‚ã€‚";
            else advice += "æ‚¨çš„ BMI åœ¨æ¨™æº–ç¯„åœå…§ï¼Œè«‹ä¿æŒï¼";

            if (data.fat > 25) advice += "<br>é«”è„‚ç‡ç•¥é«˜ï¼Œå»ºè­°æ³¨æ„é£²é£Ÿæ§åˆ¶ã€‚";
            if (data.muscle > data.weight * 0.4) advice += "<br>æ‚¨çš„è‚Œè‚‰é‡è¡¨ç¾å¾ˆæ£’ï¼";

            inbodyAnalysis.innerHTML = advice;
        }

        // ================= AI Advisor (Rule-based + Speech) =================
        const chatLog = document.getElementById('chatLog');
        const userMsg = document.getElementById('userMsg');
        const sendMsgBtn = document.getElementById('sendMsg');
        const startRecBtn = document.getElementById('startRec');
        const stopRecBtn = document.getElementById('stopRec');
        const speakLastBtn = document.getElementById('speakLast');

        let lastAIResp = '';
        sendMsgBtn.addEventListener('click', () => {
            const text = userMsg.value.trim();
            if (!text) return;
            appendChat('æˆ‘', text);
            userMsg.value = '';
            aiRespond(text);
        });

        function appendChat(who, text) {
            const div = document.createElement('div');
            const isUser = who === 'æˆ‘' || who.includes('æˆ‘');
            
            div.style.cssText = `
                padding: 10px 15px;
                border-radius: 18px;
                margin-bottom: 10px;
                max-width: 75%;
                word-wrap: break-word;
                font-size: 15px;
                line-height: 1.5;
                align-self: ${isUser ? 'flex-end' : 'flex-start'};
                background-color: ${isUser ? '#d48885' : 'rgba(255,255,255,0.15)'};
                color: #fff;
                border-bottom-${isUser ? 'right' : 'left'}-radius: 4px;
            `;
            
            div.textContent = text; 
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function aiRespond(text) {
            const low = text.toLowerCase();
            let resp = "æŠ±æ­‰ï¼Œæˆ‘ç›®å‰åªèƒ½æä¾›ç°¡å–®å»ºè­°ã€‚è«‹æ›´å…·é«”æè¿°å•é¡Œï¼Œä¾‹å¦‚ã€Œæ¸›è‚¥ã€ã€ã€Œå¢è‚Œã€æˆ–ã€ŒInBodyå»ºè­°ã€ã€‚";
            
            // ç°¡å–®çš„é—œéµå­—è¦å‰‡
            if (low.includes('æ¸›è‚¥') || low.includes('ç˜¦')) resp = "æ¸›è„‚å»ºè­°ï¼šæ¯é€±é€²è¡Œ 3 æ¬¡æœ‰æ°§é‹å‹•ï¼ˆå¦‚è·‘æ­¥ã€æ¸¸æ³³ï¼‰30åˆ†é˜ä»¥ä¸Šï¼Œä¸¦æ§åˆ¶ç¢³æ°´åŒ–åˆç‰©æ”å–ï¼Œè£½é€ ç†±é‡èµ¤å­—ã€‚";
            if (low.includes('å¢è‚Œ')) resp = "å¢è‚Œå»ºè­°ï¼šå°ˆæ³¨æ–¼å¤§é‡é‡è¤‡åˆå‹•ä½œï¼ˆæ·±è¹²ã€ç¡¬èˆ‰ï¼‰ï¼Œæ¯çµ„ 8-12 ä¸‹ã€‚è›‹ç™½è³ªæ”å–å»ºè­°ç‚ºé«”é‡ x 1.6~2.0 å…‹ã€‚";
            if (low.includes('èœå–®') || low.includes('è¨ˆç•«')) resp = "æ¨è–¦æ–°æ‰‹èœå–®ï¼šé€±ä¸€ç·´èƒ¸èˆ‡ä¸‰é ­ï¼Œé€±ä¸‰ç·´èƒŒèˆ‡äºŒé ­ï¼Œé€±äº”ç·´è…¿èˆ‡æ ¸å¿ƒã€‚è¨˜å¾—åŠ å…¥æˆ‘çš„è¨“ç·´æ¸…å–®å–”ï¼";
            if (low.includes('inbody') || low.includes('æ•¸æ“š')) resp = "InBody æ•¸æ“šèƒ½åæ˜ èº«é«”çµ„æˆã€‚è‹¥é«”è„‚é«˜ï¼Œå¤šåšæœ‰æ°§ï¼›è‹¥éª¨éª¼è‚Œä½ï¼Œè«‹åŠ å¼·é‡è¨“ã€‚";
            if (low.includes('ä½ å¥½') || low.includes('å—¨')) resp = "å—¨ï¼æˆ‘æ˜¯æ‚¨çš„ AI å¥èº«é¡§å•ï¼Œä»Šå¤©æƒ³è¨è«–è¨“ç·´é‚„æ˜¯é£²é£Ÿå‘¢ï¼Ÿ";

            lastAIResp = resp;
            setTimeout(() => {
                appendChat('AI', resp);
                speakText(resp);
            }, 600); // æ¨¡æ“¬å»¶é²
        }

        // TTS
        function speakText(text) {
            if (!('speechSynthesis' in window)) return;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-TW';
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        }
        speakLastBtn.addEventListener('click', () => {
            if (lastAIResp) speakText(lastAIResp);
        });

        // STT (Web Speech API)
        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.lang = 'zh-TW';
            recognition.interimResults = false;
            recognition.continuous = false;
            recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                appendChat('æˆ‘(èªéŸ³)', txt);
                aiRespond(txt);
            };
            recognition.onend = () => {
                startRecBtn.disabled = false;
                stopRecBtn.disabled = true;
                startRecBtn.textContent = 'ğŸ¤ èªéŸ³è¼¸å…¥';
            };
        } else {
            startRecBtn.disabled = true;
            startRecBtn.title = 'æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜';
        }

        startRecBtn.addEventListener('click', () => {
            if (!recognition) return;
            recognition.start();
            startRecBtn.disabled = true;
            startRecBtn.textContent = 'è†è½ä¸­...';
            stopRecBtn.disabled = false;
        });
        stopRecBtn.addEventListener('click', () => {
            if (!recognition) return;
            recognition.stop();
        });

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
                alert("æ‚¨å·²æˆåŠŸç™»å‡ºï¼");
                window.location.href = "login.html";
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—ï¼š", error);
                alert("ç™»å‡ºå¤±æ•—");
            }
        };

    </script>
</body>

</html>
